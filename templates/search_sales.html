{% extends 'base.html' %}
{% block content %}
  <h2>Search Sales</h2>

  <form id="search-form" class="row g-2 mb-3" method="get" action="{{ url_for('search_sales') }}">
    <div class="col-md-5">
      <input class="form-control" name="q" placeholder="Search by sale ID, medicine or customer" value="{{ q or '' }}">
    </div>
    <div class="col-md-3">
      <input class="form-control" name="from_date" type="date" value="{{ from_date or '' }}">
    </div>
    <div class="col-md-3">
      <input class="form-control" name="to_date" type="date" value="{{ to_date or '' }}">
    </div>
    <div class="col-md-1">
      <button class="btn btn-secondary" type="submit">Search</button>
    </div>
  </form>

  <div id="results-container">
    <div class="d-flex justify-content-between align-items-center">
      <p class="mb-0"><strong>Total (filtered):</strong> {{'%.2f'|format(total_all)}}</p>
      <div class="btn-group">
        <a id="search-export" href="{{ url_for('export_sales', q=q or '', from_date=from_date or '', to_date=to_date or '') }}" class="btn btn-sm btn-success">Export</a>
        <a id="search-clear" href="{{ url_for('search_sales') }}" class="btn btn-sm btn-outline-secondary">Clear</a>
      </div>
    </div>

    <p class="mt-2"><strong>Showing page</strong> {{ pagination.page }} <strong>of</strong> {{ pagination.pages }} — <strong>Total results:</strong> {{ pagination.total }}</p>

    <table class="table table-sm table-striped">
      <thead><tr><th>ID</th><th>Medicine</th><th>Customer</th><th>Qty</th><th>Total</th><th>Time</th></tr></thead>
      <tbody>
        {% for s in all_sales %}
          <tr>
            <td>{{s.id}}</td>
            <td>{{s.medicine.name}}</td>
            <td>{{s.customer.name if s.customer else '—'}}</td>
            <td>{{s.quantity}}</td>
            <td>{{'%.2f'|format(s.total_price)}}</td>
            <td>{{s.timestamp}}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <nav aria-label="Sales pagination">
      <ul class="pagination">
        <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('search_sales', q=q or '', from_date=from_date or '', to_date=to_date or '', page=pagination.prev_num, per_page=request.args.get('per_page',10)) }}">&laquo; Prev</a>
        </li>
        <li class="page-item disabled"><span class="page-link">Page {{ pagination.page }} / {{ pagination.pages }}</span></li>
        <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('search_sales', q=q or '', from_date=from_date or '', to_date=to_date or '', page=pagination.next_num, per_page=request.args.get('per_page',10)) }}">Next &raquo;</a>
        </li>
      </ul>
    </nav>
  </div>
  
{% endblock %}

{% block extra_scripts %}
  <script>
    (function(){
      const clearBtn = document.getElementById('search-clear');
      if(!clearBtn) return;
      clearBtn.addEventListener('click', function(ev){
        // prevent the default anchor navigation and explicitly reset and reload without querystring
        ev.preventDefault();
        const form = document.getElementById('search-form');
        if(form) form.reset();
        // hide/clear the results container
        const results = document.getElementById('results-container');
        if(results) results.innerHTML = '';
        // remove query parameters from the URL without reloading
        try{ window.history.replaceState({}, '', this.getAttribute('href')); }catch(e){}
      });
    })();
  </script>
{% endblock %}
